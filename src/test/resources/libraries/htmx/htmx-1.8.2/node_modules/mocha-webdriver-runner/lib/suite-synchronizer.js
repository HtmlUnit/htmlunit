"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMochaStateSynchronizer = void 0;
var treesync_1 = require("@zbigg/treesync");
var mocha = require("mocha");
var MOCHA_SUITE_SYNCHRONIZED_PROPERTIES = [
    "title",
    "tests",
    "_beforeAll",
    "_afterAll",
    "_beforeEach",
    "_afterEach",
    "suites",
    "pending",
    "passes",
    "failures",
    "file",
    "delayed",
    "parent",
    "root",
    "rootEmpty",
    "duration",
    "title"
];
var MOCHA_TEST_SYNCHRONIZED_PROPERTIES = [
    "title",
    "speed",
    "body",
    "fn",
    "type",
    "err",
    "parent",
    "title",
    "state",
    "pending",
    "skipped",
    "duration",
    "currentRetry",
    "context",
    "ctx"
];
var MOCHA_HOOK_SYNCHRONIZED_PROPERTIES = ["title", "type", "state", "duration", "parent", "fn", "ctx", "file"];
function createMochaStateSynchronizer() {
    var synchronizer = new treesync_1.Synchronizer();
    if (typeof mocha === "undefined") {
        throw new Error("mocha not loaded, cannot create Mocha Suite/Test synchronizer");
    }
    synchronizer.serializationContext.addClass({
        name: "Mocha.Suite",
        constructor: mocha.Suite,
        factory: function () {
            return new mocha.Suite("dummy-test");
        },
        propertyFilter: function (name) {
            return MOCHA_SUITE_SYNCHRONIZED_PROPERTIES.includes(name);
        }
    });
    synchronizer.serializationContext.addClass({
        name: "Mocha.Test",
        constructor: mocha.Test,
        factory: function () {
            return new mocha.Test("dummy-test", function () { });
        },
        propertyFilter: function (name) {
            return MOCHA_TEST_SYNCHRONIZED_PROPERTIES.includes(name);
        },
        propertyMapSerialize: function (name, value) {
            if (name === "fn" && typeof value === "function") {
                return value.toString();
            }
            return value;
        }
    });
    synchronizer.serializationContext.addClass({
        name: "Mocha.Hook",
        constructor: mocha.Hook,
        factory: function () {
            return new mocha.Hook("dummy-hook");
        },
        propertyFilter: function (name) {
            return MOCHA_HOOK_SYNCHRONIZED_PROPERTIES.includes(name);
        },
        propertyMapSerialize: function (name, value) {
            if (name === "fn" && typeof value === "function") {
                return value.toString();
            }
            return value;
        }
    });
    return synchronizer;
}
exports.createMochaStateSynchronizer = createMochaStateSynchronizer;
